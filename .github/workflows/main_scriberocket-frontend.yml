name: Build and deploy Node.js app to Azure Web App - scriberocket-frontend

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - ".github/workflows/main_scriberocket-frontend.yml"
  workflow_dispatch:

concurrency:
  group: frontend-prod
  cancel-in-progress: true

env:
  RG: scriberocket-prod
  FE_APP: scriberocket-frontend

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Set NEXT_PUBLIC_API_URL for build
        run: echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> $GITHUB_ENV

      - name: Build with Next.js
        run: npm run build

      - name: Prepare Standalone Artifact
        run: |
          rm -rf deployment
          mkdir -p deployment

          echo "Copying Next.js standalone output..."
          cp -r .next/standalone/* deployment/

          echo "Ensuring .next artifacts..."
          mkdir -p deployment/.next

          # static assets
          cp -r .next/static deployment/.next/

          # critical build id
          cp .next/BUILD_ID deployment/.next/BUILD_ID

          # server folder
          if [ -d ".next/server" ]; then
            cp -r .next/server deployment/.next/
          fi

          # copy root manifest files
          shopt -s nullglob
          for f in .next/*.json; do
            cp "$f" deployment/.next/
          done
          shopt -u nullglob

          echo "Copying public/..."
          cp -r public deployment/

          echo "Preserving Next standalone server.js..."
          if [ -f "deployment/server.js" ]; then
            mv deployment/server.js deployment/next-server.js
          else
            echo "ERROR: Next standalone did not produce deployment/server.js"
            find .next/standalone -maxdepth 3 -type f
            exit 1
          fi

          echo "Creating Azure root server.js wrapper..."
          printf '%s\n' 'process.chdir(__dirname);' 'require("./next-server.js");' > deployment/server.js

          echo "=== server.js content ==="
          cat deployment/server.js
          echo "========================="

          echo "Sanity checks:"
          test -f deployment/server.js
          test -f deployment/next-server.js
          test -f deployment/.next/BUILD_ID
          test -f deployment/.next/routes-manifest.json
          test -d deployment/.next/static

      - name: Check artifact size
        run: |
          echo "=== Deployment artifact size ==="
          du -sh deployment
          du -sh deployment/.next
          du -sh deployment/node_modules || echo "No node_modules in deployment"
          echo "File count: $(find deployment -type f | wc -l)"
          echo "================================"

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: frontend/deployment/
          include-hidden-files: true

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: node-app
          path: artifact

      - name: Verify artifact before deploy
        run: |
          echo "=== Artifact verification ==="
          ls -la artifact
          du -sh artifact
          echo "File count: $(find artifact -type f | wc -l)"
          test -f artifact/server.js
          test -f artifact/next-server.js
          test -f artifact/.next/BUILD_ID
          test -d artifact/.next/static
          echo "============================="

      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_F83161DF85894767B325559E9679FCD6 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_80598241AF434D9E823D6A38824C6179 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_72231FF6346C495381370352E7D7A15B }}

      - name: Deploy to Production
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.FE_APP }}
          package: artifact

      - name: Log deploy result
        run: |
          echo "=== Deploy completed ==="
          echo "App URL: https://${{ env.FE_APP }}.azurewebsites.net"
          echo "========================"

      - name: Health check
        run: |
          set -euo pipefail
          URL="https://${{ env.FE_APP }}.azurewebsites.net/"
          echo "Checking: $URL"
          echo "Started at: $(date)"

          max_attempts=30
          sleep_seconds=10

          for i in $(seq 1 $max_attempts); do
            code=$(curl -s -o /dev/stderr -w "%{http_code}" "$URL" || echo "000")
            if [ "$code" = "200" ]; then
              echo ""
              echo "✅ Frontend health OK at $(date)"
              exit 0
            fi
            echo ""
            echo "Not ready (HTTP $code). Attempt $i/$max_attempts... $(date)"
            sleep $sleep_seconds
          done

          echo "❌ Frontend health check failed at $(date)"
          exit 1
